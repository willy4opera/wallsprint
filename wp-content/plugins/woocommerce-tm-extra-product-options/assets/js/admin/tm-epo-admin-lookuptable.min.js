!function(l,e,c){"use strict";var r=l.wp,a=l._,s=l.TMEPOADMINLOOKUPJS,d=l.toastr,o=l.plupload,t={tc_builder_elements:r.template("tc-builder-elements"),tc_builder_section:r.template("tc-builder-section")},m=s.lookuptable;function u(){return""===s.tm_epo_global_displayed_decimal_separator?s.currency_format_decimal_sep:c.epoAPI.locale.getSystemDecimalSeparator()}function p(t){var e,t=String(t);return t.includes("e-")?(e=t.split("e-"),Number(e[1])+Number(p(e[0]))):t.includes(".")?t.split(".")[1].length:0}function f(){var i,n={},l={},s={};return c(".lookup-table").toArray().forEach(function(t){t=c(t),i=t.closest(".lookup-table-wrap").prev(".lookuptable-name").find(".table-name-value").text(),n[i]={},t.find(".row").toArray().forEach(function(t){c(t).find(".ltcell").toArray().forEach(function(t){var t=c(t),e=t.attr("data-row"),o=t.attr("data-column"),a=t.text(),r=a.replace(/,/g,".");"1"===e&&"1"===o||(t.is(".head .ltcell, .column1")&&!String(r).isNumeric()||(t=c.epoAPI.math.toFloat(r),a="max"!==r&&isNaN(t)?0:r),"1"===o?s[e]=a:"1"===e?l[o]=a:(void 0===n[i][l[o]]&&(n[i][l[o]]={}),n[i][l[o]][s[e]]=a))})})}),n}c.tmEPOAdmin={addEventsDone:0,addEvents:function(){var n,t=c("#builder_import_file"),t=new o.Uploader({url:s.ajax_url,browse_button:t[0],file_data_name:"builder_import_file",multi_selection:!1});t.init(),t.bind("FilesAdded",function(t){function e(){c("#tc-floatbox-content").find(".override-selection").addClass("tc-hidden"),o.appendTo("#tc-floatbox-content"),c(".tc-progress-info-content").html(s.i18n_importing),t.setOption("multipart_params",{action:"tc_lookup_table_import",post_id:s.post_id,security:s.import_nonce}),t.start(),c(".flasho").addClass("tc-color-notice")}var o,a=c.tmEPOAdmin.builder_floatbox_template_import({id:"tc-floatbox-content",html:"",title:s.i18n_import_title});n=c.tcFloatBox({closefadeouttime:0,animateOut:"",fps:1,ismodal:!0,refresh:"fixed",width:"50%",minHeight:"300px",classname:"flasho tc-wrapper",data:a}),o=c('<div class="tc-progress-bar tc-notice"><span class="tc-percent"></span></div><div class="tc-progress-info"><span class="tc-progress-info-content"></span></div>'),c(".lookuptable-wrapper").length?(c('<div class="override-selection"><button type="button" class="tc tc-button details-override">'+s.i18n_overwrite_existing_tables+"</button></div>").appendTo("#tc-floatbox-content"),c(".details-override").on("click",function(){e()})):e()}),t.bind("FileUploaded",function(t,e,o){var a,r,i=c.epoAPI.util.parseJSON(o.response);i&&void 0!==i.result&&i.message&&c(".tc-progress-info-content").html(i.message),i&&i.error&&i.message&&c(".tc-progress-info-content").html(i.message),i&&void 0!==i.result&&1===c.epoAPI.math.toFloat(i.result)?(c(".tc-progress-bar").removeClass("tc-notice").addClass("tc-success"),c(".tc-progress-info-content").removeClass("tc-color-error").addClass("tc-color-success"),c(".flasho").removeClass("tc-color-notice tc-color-error").addClass("tc-color-success"),c(".floatbox-cancel").addClass("tc-hidden"),c(".tc-progress-info-content").html(s.i18n_saving),c(l).off("beforeunload.edit-post"),i.table?Array.isArray(i.jsobject)?(c(".builder-layout").html(i.table),c.tmEPOAdmin.initSectionsCheck(),d.success(i.message,s.i18n_epo),(a=c("#title")).length&&""===a.val()&&(a.val(Object.keys(i.jsobject[0])[0]),c("#title-prompt-text").addClass("screen-reader-text"),"publish"===c("#publish").attr("name"))&&c("#publish").trigger("click")):d.error(s.i18n_invalid_request,s.i18n_epo):i.different?(r=1,c(".details-override").on("click",function(){c.post(s.ajax_url,{action:"tc_lookup_table_import",import_override:1,post_id:s.post_id,security:s.import_nonce},function(t){(i=t).table&&(Array.isArray(i.jsobject)?(c(".builder-layout").html(i.table),c.tmEPOAdmin.initSectionsCheck(),d.success(i.message,s.i18n_epo)):d.error(s.i18n_invalid_request,s.i18n_epo))},"json").always(function(){n.destroy()})}),c("#tc-floatbox-content").find(".override-selection").removeClass("tc-hidden").addClass("height50").insertAfter(c(".tc-progress-info")),c(".floatbox-cancel").removeClass("tc-hidden"),c(".tc-progress-bar").addClass("tc-hidden"),c(".tc-progress-info-content").removeClass("tc-color-success tc-color-error").addClass("tc-color-notice").html(i.message),c(".flasho").removeClass("tc-color-success tc-color-error").addClass("tc-color-notice")):d.error(s.i18n_invalid_csv,s.i18n_epo),r||n.destroy()):(c(".tc-progress-bar").removeClass("tc-notice").addClass("tc-error"),c(".tc-progress-info-content").removeClass("tc-color-success").addClass("tc-color-error"),c(".flasho").removeClass("tc-color-notice tc-color-success").addClass("tc-color-error"),!i&&o&&o.response&&c(".tc-progress-info-content").addClass("tc-normalize").html(o.response),d.error(s.i18n_invalid_request,s.i18n_epo))}),t.bind("UploadProgress",function(t,e){e=parseInt(e.percent,10);c(".tc-progress-bar").css("width",e+"%"),c(".tc-percent").html(e+"%")}),t.bind("Error",function(t,e){e&&e.message&&c(".tc-progress-info-content").removeClass("tc-color-success").addClass("tc-color-error").html("\nError #"+e.code+": "+e.message),c(".tc-progress-bar").removeClass("tc-notice").addClass("tc-error"),c(".flasho").removeClass("tc-color-notice tc-color-success").addClass("tc-color-error"),e&&e.response&&(c(".flasho .header h3").html(e.message),c(".tc-progress-info-content").addClass("tc-normal-font").html(e.response)),d.error(s.i18n_invalid_request,s.i18n_epo)}),t.bind("UploadComplete",function(){c("body").removeClass("overflow")}),c(e).on("click.cpf",".tc-add-import-csv",function(t){t.preventDefault(),c("#builder_import_file").trigger("click")}),c(e).on("click.cpf",".tc-add-export-csv",function(t){var e=c(this);t.preventDefault(),e.data("doing_export")||(e.data("doing_export",1).prepend('<i class="tm-icon tcfa tcfa-spin tcfa-spinner"></i>'),t={action:"tc_lookup_table_export",metaserialized:JSON.stringify(m),security:s.export_nonce},c.post(s.ajax_url,t,function(t){t&&t.result&&""!==t.result?l.location=t.result:(t=t&&t.error&&t.message?t.message:s.i18n_error_message,t=c.tmEPOAdmin.builder_floatbox_template_import({id:"tc-floatbox-content",html:'<div class="tm-inner">'+t+"</div>",title:s.i18n_error_title}),c.tcFloatBox({closefadeouttime:0,animateOut:"",fps:1,ismodal:!0,refresh:"fixed",width:"50%",minHeight:"300px",classname:"flasho tc-wrapper tm-error",data:t}))},"json").always(function(){e.data("doing_export",0).find(".tm-icon").remove()}))}),c(e).on("mouseover",".ltcell",function(){var t=c(this),e=t.parent().parent().parent(),o=t.parent().parent(),a=c(e).data("vertable")+"",r=t.data("column")+"",t=t.data("row")+" .column1";c(o).find("."+r).addClass("hov-column-"+a),c(e).find(".row.head ."+r).addClass("hov-column-head-"+a),c(e).find(".row."+t).addClass("hov-column-head-"+a)}),c(e).on("mouseout",".ltcell",function(){var t=c(this),e=t.parent().parent().parent(),o=t.parent().parent(),a=c(e).data("vertable")+"",r=t.data("column")+"",t=t.data("row")+" .column1";c(o).find("."+r).removeClass("hov-column-"+a),c(e).find(".row.head ."+r).removeClass("hov-column-head-"+a),c(e).find(".row."+t).removeClass("hov-column-head-"+a)}),c(e).on("keypress",'[contenteditable="true"]',function(t){13===t.which&&(t.preventDefault(),c(this).trigger("blur"))}),c(e).on("focus",'[contenteditable="true"]',function(){var t=c(this);t.attr("data-value",t.text())}),c(e).on("blur",'.head [contenteditable="true"], .column1[contenteditable="true"]',function(){var t=c(this),e=t.text(),o=t.attr("data-row"),a=t.attr("data-column"),r=t.attr("data-value");if(void 0===r&&(r=0),""===e){if("1"===a||"1"===o)return void t.html(r)}else""!==e&&String(e).isNumeric()&&(e=t.text().replace(/,/g,"."),a={symbol:"",format:"",decimal:u(),thousand:"",precision:p(c.epoAPI.math.toFloat(e))},e=c.epoAPI.math.format(e,a)),t.html(e);m=f()}),c(e).on("blur",'[contenteditable="true"]:not(.head [contenteditable="true"], .column1)',function(){var t,e=c(this),o=e.text().replace(/,/g,"."),a=c.epoAPI.math.toFloat(o),r={symbol:"",format:"",decimal:u(),thousand:"",precision:p(a)},i=e.attr("data-row"),n=e.attr("data-column"),l=e.attr("data-value");if(void 0===l&&(l=0),e.is(".table-name-value"))""===o&&e.html(l);else if(t=e.closest("table").find("tr").length,""===o){if("1"===n||"1"===i)return void e.html(l)}else if("max"===o){if(1<Number(i)){if(Number(i)<t||1<Number(n))return void e.html(l)}else if(1===Number(i)&&Number(n)<=e.siblings().length)return void e.html(l);e.html(o)}else isNaN(a)||isNaN(Number(o))?e.html(l):(""!==o&&(o=c.epoAPI.math.format(o,r)),e.html(o));m=f()})},tm_escape:function(t){return encodeURIComponent(t)},createLookuptableMeta:function(){var t,e=c("input#wp-preview"),o=c("#tmformfieldsbuilderwrap");a.isEqual(s.lookuptable,m)||(c(".lookuptable-meta").remove(),t=c.tmEPOAdmin.tm_escape(JSON.stringify(m)),t=c("<textarea class='lookuptable-meta tm-hidden' name='lookuptable_meta_changed'></textarea>").val(t),o.prepend(t),0<e.length&&""!==e.val()&&c(".lookuptable-meta").remove())},fixFormSubmit:function(){var a,t=c("#post");1===t.length?t.on("submit",function(){return c.tmEPOAdmin.createLookuptableMeta(),!0}):r.data&&void 0!==r.data.subscribe&&(a=!1,"function"==typeof(t=r.data.subscribe))&&t(function(){var t,e,o;r.data.select("core/editor")&&(e=r.data.select("core/editor").didPostSaveRequestSucceed(),o=r.data.select("core/editor").didPostSaveRequestFail(),r&&r.data&&r.data.select("core/editor")&&(t=r.data.select("core/editor").isSavingPost()),!a&&t&&(a=!0,c.tmEPOAdmin.createLookuptableMeta()),a)&&(e||o)&&(a=!1,setTimeout(function(){c(".lookuptable-meta").remove()},600))})},initialitize:function(){c.tmEPOAdmin.initSectionsCheck(),c.tmEPOAdmin.addEvents(),c(".builder-layout").removeClass("tm-hidden"),c.tmEPOAdmin.fixFormSubmit()},initSectionsCheck:function(){c(".lookuptable-wrapper").length?(c(".builder-add-section-action").show(),c(".builder-selector").show(),c(".tc-welcome").hide(),c(".builder-layout").show(),c(".tc-add-export-csv").show()):(c(".builder-add-section-action").hide(),c(".builder-selector").hide(),c(".tc-welcome").show(),c(".builder-layout").hide(),c(".tc-add-export-csv").hide())},builder_floatbox_template:function(t,e){return c.epoAPI.template.html(r.template(e||"tc-floatbox"),{id:t.id,title:t.title,html:t.html,uniqidtext:t.uniqidtext||"",uniqid:t.uniqid,update:t.update||s.i18n_update,cancel:t.cancel||s.i18n_cancel})},builder_floatbox_template_import:function(t){return c.epoAPI.template.html(r.template("tc-floatbox-import"),{id:t.id,title:t.title,html:t.html,cancel:s.i18n_cancel})}},c(function(){t=c.epoAPI.applyFilter("tc_adjust_admin_template_engine",t),c.tmEPOAdmin.initialitize()})}(window,document,window.jQuery);